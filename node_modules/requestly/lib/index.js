var N=Object.create;var q=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,M=Object.prototype.hasOwnProperty;var W=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var B=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of $(e))!M.call(t,i)&&i!==r&&q(t,i,{get:()=>e[i],enumerable:!(s=H(e,i))||s.enumerable});return t};var G=(t,e,r)=>(r=t!=null?N(D(t)):{},B(e||!t||!t.__esModule?q(r,"default",{value:t,enumerable:!0}):r,t));var L=W((ee,y)=>{"use strict";var R={decodeValues:!0,map:!1,silent:!1};function _(t){return typeof t=="string"&&!!t.trim()}function b(t,e){var r=t.split(";").filter(_),s=r.shift(),i=V(s),a=i.name,o=i.value;e=e?Object.assign({},R,e):R;try{o=e.decodeValues?decodeURIComponent(o):o}catch(u){console.error("set-cookie-parser encountered an error while decoding a cookie with value '"+o+"'. Set options.decodeValues to false to disable this feature.",u)}var n={name:a,value:o};return r.forEach(function(u){var h=u.split("="),l=h.shift().trimLeft().toLowerCase(),p=h.join("=");l==="expires"?n.expires=new Date(p):l==="max-age"?n.maxAge=parseInt(p,10):l==="secure"?n.secure=!0:l==="httponly"?n.httpOnly=!0:l==="samesite"?n.sameSite=p:l==="partitioned"?n.partitioned=!0:n[l]=p}),n}function V(t){var e="",r="",s=t.split("=");return s.length>1?(e=s.shift(),r=s.join("=")):r=t,{name:e,value:r}}function U(t,e){if(e=e?Object.assign({},R,e):R,!t)return e.map?{}:[];if(t.headers)if(typeof t.headers.getSetCookie=="function")t=t.headers.getSetCookie();else if(t.headers["set-cookie"])t=t.headers["set-cookie"];else{var r=t.headers[Object.keys(t.headers).find(function(i){return i.toLowerCase()==="set-cookie"})];!r&&t.headers.cookie&&!e.silent&&console.warn("Warning: set-cookie-parser appears to have been called on a request object. It is designed to parse Set-Cookie headers from responses, not Cookie headers from requests. Set the option {silent: true} to suppress this warning."),t=r}if(Array.isArray(t)||(t=[t]),e.map){var s={};return t.filter(_).reduce(function(i,a){var o=b(a,e);return i[o.name]=o,i},s)}else return t.filter(_).map(function(i){return b(i,e)})}function F(t){if(Array.isArray(t))return t;if(typeof t!="string")return[];var e=[],r=0,s,i,a,o,n;function u(){for(;r<t.length&&/\s/.test(t.charAt(r));)r+=1;return r<t.length}function h(){return i=t.charAt(r),i!=="="&&i!==";"&&i!==","}for(;r<t.length;){for(s=r,n=!1;u();)if(i=t.charAt(r),i===","){for(a=r,r+=1,u(),o=r;r<t.length&&h();)r+=1;r<t.length&&t.charAt(r)==="="?(n=!0,r=o,e.push(t.substring(s,a)),s=r):r=a+1}else r+=1;(!n||r>=t.length)&&e.push(t.substring(s,t.length))}return e}y.exports=U;y.exports.parse=U;y.exports.parseString=b;y.exports.splitCookiesString=F});var g=class t{key;value;expires;maxAge;domain;path;secure;httpOnly;constructor(e){this.key=e.key,this.value=e.value,this.expires=e.expires,this.maxAge=e.maxAge,this.domain=e.domain,this.path=e.path,this.secure=e.secure||!1,this.httpOnly=e.httpOnly||!1}static parse(e){let r=e.split(";").map(u=>u.trim()),[s,...i]=r,[a,o]=s.split("=").map(u=>u.trim());if(!a||!o)return null;let n={key:a,value:o};return i.forEach(u=>{let[h,l]=u.split("=").map(p=>p.trim());switch(h.toLowerCase()){case"expires":n.expires=new Date(l);break;case"max-age":n.maxAge=parseInt(l,10);break;case"domain":n.domain=l;break;case"path":n.path=l;break;case"secure":n.secure=!0;break;case"httponly":n.httpOnly=!0;break}}),new t(n)}toString(){let e=`${this.key}=${this.value}`;return this.expires&&(e+=`; Expires=${this.expires.toUTCString()}`),this.maxAge!==void 0&&(e+=`; Max-Age=${this.maxAge}`),this.domain&&(e+=`; Domain=${this.domain}`),this.path&&(e+=`; Path=${this.path}`),this.secure&&(e+="; Secure"),this.httpOnly&&(e+="; HttpOnly"),e}},d=class t{cookies=[];async setCookie(e,r,s={}){let i=new URL(r).hostname;if(e.domain&&!i.endsWith(e.domain)){if(!s.ignoreError)throw new Error("Cookie domain does not match URL");return}this.cookies=this.cookies.filter(a=>a.key!==e.key||a.domain!==e.domain),this.cookies.push(e)}async getCookies(e){let r=new URL(e).hostname,s=new URL(e).pathname;return this.cookies.filter(i=>(!i.domain||r.endsWith(i.domain))&&(!i.path||s.startsWith(i.path)))}async getCookieString(e){return(await this.getCookies(e)).map(s=>`${s.key}=${s.value}`).join("; ")}serializeSync(){return{cookies:this.cookies.map(e=>({key:e.key,value:e.value,expires:e.expires?.toISOString(),maxAge:e.maxAge,domain:e.domain,path:e.path,secure:e.secure,httpOnly:e.httpOnly}))}}static deserializeSync(e){let r=new t;return r.cookies=e.cookies.map(s=>new g({key:s.key,value:s.value,expires:s.expires?new Date(s.expires):void 0,maxAge:typeof s.maxAge=="number"?s.maxAge:void 0,domain:s.domain,path:s.path,secure:typeof s.secure=="boolean"?s.secure:void 0,httpOnly:typeof s.httpOnly=="boolean"?s.httpOnly:void 0})),r}};var I=G(L(),1);var S="Requestly/1.0";function P(t){if(t==null)return{body:t,contentType:null};if(t instanceof FormData)return{body:t,contentType:null};if(t instanceof URLSearchParams)return{body:t,contentType:"application/x-www-form-urlencoded"};if(t instanceof Blob||t instanceof File)return{body:t,contentType:t.type||"application/octet-stream"};if(t instanceof ArrayBuffer||ArrayBuffer.isView(t))return{body:t,contentType:"application/octet-stream"};if(typeof t=="object")return{body:JSON.stringify(t),contentType:"application/json"};if(typeof t=="string")try{return JSON.parse(t),{body:t,contentType:"application/json"}}catch{return{body:t,contentType:"text/plain"}}return{body:t,contentType:null}}async function E(t,e,r){let i=await(t.headers.get("Content-Type")?.includes("application/json")?t.json():t.text());return{...t,url:t.url,ok:t.ok,redirected:e.redirectCount>0,status:t.status,statusText:t.statusText,request:{url:e.url,method:e.method,options:e.options},cookies:{},headers:t.headers,data:i,retry:r}}var v=class t{static URL_PATTERN=/^https?:\/\//i;static PROTOCOL_PATTERN=/^(https?:\/\/)/i;static MULTIPLE_SLASHES=/\/+/g;static TRAILING_SLASH=/\/+$/;static LEADING_SLASH=/^\/+/;createUrl(e,r="",s){try{if(r=this.normalizeUrl(r),!e)return this.addQueryParams(r,s);if(t.URL_PATTERN.test(e))return this.addQueryParams(this.cleanUrl(e),s);if(e.startsWith("//"))throw new Error("Invalid path: Cannot start with multiple slashes");let i=e.startsWith("/")?e.slice(1):e,o=r?`${r||"https://"}/${i}`:`https://${i}`;return this.addQueryParams(this.cleanUrl(o),s)}catch(i){throw new Error(`Invalid URL creation: ${i instanceof Error?i.message:"Unknown error"}`)}}normalizeUrl(e){if(!e)return"";try{let r=e.trim(),s=t.URL_PATTERN.test(r)?r:`https://${r}`,i=this.cleanUrl(s);return new URL(i),i}catch{if(e.trim())throw new Error(`Invalid URL: ${e}`);return""}}cleanUrl(e){let r=e.match(t.PROTOCOL_PATTERN);if(!r)return e.replace(t.MULTIPLE_SLASHES,"/").replace(t.TRAILING_SLASH,"");let[s]=r;return s+e.slice(s.length).replace(t.MULTIPLE_SLASHES,"/").replace(t.LEADING_SLASH,"").replace(t.TRAILING_SLASH,"")}addQueryParams(e,r){if(!r||Object.keys(r).length===0)return e;try{let s=new URL(e);for(let[i,a]of Object.entries(r))a!=null&&s.searchParams.append(i,a);return this.cleanUrl(s.toString())}catch{throw new Error(`Invalid URL while adding parameters: ${e}`)}}};var K=new Set([301,302,303,307,308]),A=class t{_baseUrl;_headers={};_params={};_cookieJar;_onRequest;_onResponse;_maxRedirects;_urlHandler=new v;constructor(e){if(typeof e=="string"){this._baseUrl=e,this._cookieJar=new d,this._maxRedirects=20;return}this._baseUrl=e?.baseUrl??"",this._headers=e?.headers??{},this._params=e?.params??{},this._cookieJar=new d,e?.cookies&&this.cookies.deserialize(e.cookies),this._headers["User-Agent"]=e?.userAgent??S,this._onRequest=e?.onRequest,this._maxRedirects=e?.maxRedirects??20}async _request(e,r,s,i=0){if(e.startsWith("/")&&this._baseUrl==null)throw new Error("Cannot make request with relative URL without a base URL");let{method:a,redirect:o}=s??{},n=this._urlHandler.createUrl(e,this.baseUrl,{...s?.params,...this._params}),{body:u,contentType:h}=P(s?.body),l=await this._cookieJar.getCookieString(n),p={...this.headers.getAll(),...l?{Cookie:l}:{},...h?{"Content-Type":h}:{},...s?.headers},C={method:r,body:u,headers:p},J=await this._onRequest?.(n,C),k={...s,...J,...C,redirect:"manual"},f=await fetch(n,k),w={},O=f.headers.get("Set-Cookie");if(O){let c=(0,I.splitCookiesString)(O);for(let T of c){let m=g.parse(T);m&&(w[m.key]=m.value,await this._cookieJar.setCookie(m,n,{ignoreError:!0}))}}let j=await this._cookieJar.getCookies(n);for(let c of j)w[c.key]=c.value;if(K.has(f.status)&&i<this._maxRedirects){let c=f.headers.get("Location");if(c){let T=new URL(c,n).pathname,m=f.status===303?"GET":r,z=f.status===303?void 0:s?.body;return this._request(T,m,{...s,body:z},i+1)}}let x=await E(f,{url:e,method:r,options:k,redirectCount:i},()=>this._request(e,r,s,i+1));if(this._onResponse){let c=await this._onResponse({url:n,init:k,response:x});if(c)return c.headers instanceof Headers?c:{...x,data:c.data}}return{...x,cookies:w}}cookies={serialize:()=>this._cookieJar.serializeSync()?.cookies??[],deserialize:e=>{this._cookieJar=d.deserializeSync({rejectPublicSuffixes:!0,storeType:"MemoryCookieStore",version:"tough-cookie@4.1.4",cookies:e})},get:async(e,r)=>{if(r)return(await this._cookieJar.getCookies(r)).find(a=>a.key===e)?.value??null;let s=this._cookieJar.serializeSync();for(let i of s.cookies)if(i.key?.toLowerCase()===e.toLowerCase())return i.value??null;return null},getAll:async e=>this._cookieJar.getCookies(e),set:async(e,r)=>{let s=new g(r);this._cookieJar.setCookie(s,e)},clear:()=>{this._cookieJar=new d}};get baseUrl(){return this._baseUrl}set baseUrl(e){this._baseUrl=e}create(e){return new t(e)}get params(){return this._params??{}}set params(e){this._params=e}headers={set:(e,r)=>{this._headers[e]=r},get:e=>this._headers[e],getAll:()=>this._headers,remove:e=>{delete this._headers[e]},update:e=>{this._headers={...e,...this._headers}}};get(e,r){return this._request(e,"GET",r)}post(e,r){return this._request(e,"POST",r)}put(e,r){return this._request(e,"PUT",r)}delete(e,r){return this._request(e,"DELETE",r)}patch(e,r){return this._request(e,"PATCH",r)}onRequest={set:e=>{this._onRequest=e},remove:()=>{this._onRequest=void 0}};onResponse={set:e=>{this._onResponse=e},remove:()=>{this._onResponse=void 0}};fetch(e,r){return this._request(e,r?.method||"GET",r)}},X=new A,se=X;export{A as Requestly,se as default,X as requestly};
